(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();const d="anticontainmentsystem",p="openworld-data",f="https://api.github.com";async function y(n,e=null){try{const t={Accept:"application/vnd.github.v3+json"};e&&(t.Authorization=`Bearer ${e}`);const o=await fetch(`${f}/repos/${d}/${p}/contents/${n}`,{headers:t});if(!o.ok){if(o.status===404)return null;throw new Error(`GitHub API error: ${o.status}`)}const r=await o.json();if(!r.content)return console.warn("[GitHubData] File has no content:",n),{data:[],sha:r.sha};let s=decodeURIComponent(escape(window.atob(r.content)));s.charCodeAt(0)===65279&&(s=s.slice(1));try{return{data:JSON.parse(s),sha:r.sha}}catch(a){return console.error("[GitHubData] React content parse error:",a),{data:[],sha:r.sha}}}catch(t){if(console.error("[GitHubData] Read error:",t),t.message.includes("404"))return null;throw t}}const h={async getAll(n=null){try{const e=await y("posts.json",n);return(e==null?void 0:e.data)||[]}catch(e){return console.error("Failed to load posts:",e),[]}},async get(n,e){try{const t=await fetch(`/.netlify/functions/get-post?id=${n}`,{headers:{Authorization:`Bearer ${e}`}});return t.ok?await t.json():null}catch(t){return console.error("[PostsAPI] Get error:",t),null}},async create(n,e){try{const t=await fetch("/.netlify/functions/create-post",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!t.ok){const o=await t.json();throw new Error(o.error||"Failed to create post")}return await t.json()}catch(t){throw console.error("[PostsAPI] Create error:",t),t}},async delete(n,e,t){try{return!!(await(await fetch("/.netlify/functions/manage-post",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({action:"delete",postId:n})})).json()).success}catch(o){return console.error("[PostsAPI] Delete error:",o),!1}},async react(n,e,t){try{const r=await(await fetch("/.netlify/functions/manage-post",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({action:"react",postId:n,reactionType:e})})).json();return r.success?r:null}catch(o){return console.error("[PostsAPI] React error:",o),null}}},$={async add(n,e,t,o){try{const r=await fetch("/.netlify/functions/add-comment",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({postId:n,content:e,attachments:t})}),s=await r.json();if(!r.ok)throw new Error(s.error||"Failed to add comment");return s.comment}catch(r){throw console.error("[CommentsAPI] Add error:",r),r}}},I={async getContents(n,e,t="",o){try{const r=t?`&path=${encodeURIComponent(t)}`:"",s=`/.netlify/functions/get-repo-contents?owner=${n}&repo=${e}${r}`,a=await fetch(s,{headers:{Authorization:`Bearer ${o}`}});return a.ok?await a.json():[]}catch(r){return console.error("[ReposAPI] Contents error:",r),[]}},async getForks(n,e,t){try{const o=await fetch(`/.netlify/functions/get-forks?owner=${n}&repo=${e}`,{headers:{Authorization:`Bearer ${t}`}});return o.ok?await o.json():[]}catch(o){return console.error("[ReposAPI] Forks error:",o),[]}},async search(n,e){try{const o=await(await fetch(`/.netlify/functions/search-repos?q=${encodeURIComponent(n)}`,{headers:{Authorization:`Bearer ${e}`}})).json();return o.error||!Array.isArray(o)?[]:o}catch(t){return console.error("[ReposAPI] Search error:",t),[]}},async getStarred(n,e){try{const t=await fetch(`${f}/users/${n}/starred?sort=created&direction=desc`,{headers:{Authorization:`Bearer ${e}`,Accept:"application/vnd.github.v3+json"}});return t.ok?await t.json():[]}catch(t){return console.error("[ReposAPI] GetStarred error:",t),[]}}},A={async getEvents(n,e=null){try{const t={Accept:"application/vnd.github.v3+json"};e&&(t.Authorization=`Bearer ${e}`);const o=await fetch(`${f}/users/${n}/events`,{headers:t});return o.ok?await o.json():[]}catch(t){return console.error("[UsersAPI] Events error:",t),[]}},async get(n,e=null){try{const t=await y(`users/${n}.json`,e);if(t!=null&&t.data)return t.data}catch{}try{console.log(`[UsersAPI] Falling back to GitHub for ${n}`);const t={Accept:"application/vnd.github.v3+json"};e&&(t.Authorization=`Bearer ${e}`);const o=await fetch(`${f}/users/${n}`,{headers:t});if(!o.ok)return null;const r=await o.json();return{id:String(r.id),username:r.login,name:r.name||r.login,avatar:r.avatar_url,bio:r.bio,location:r.location,joinedAt:r.created_at,followers:r.followers,following:r.following,repos:[],website:r.blog||r.html_url}}catch(t){return console.error("GitHub user fetch failed",t),null}},async save(n,e){try{const t=await fetch("/.netlify/functions/update-profile",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!t.ok){const r=await t.json();throw new Error(r.error||"Failed to save profile")}return(await t.json()).profile}catch(t){throw console.error("Failed to save user:",t),t}},async getAll(){try{const n=await fetch(`${f}/repos/${d}/${p}/contents/users`,{headers:{Accept:"application/vnd.github.v3+json"}});if(!n.ok)return[];const e=await n.json(),t=[];for(const o of e)if(o.name.endsWith(".json")){const r=await this.get(o.name.replace(".json",""));r&&t.push(r)}return t}catch(n){return console.error("[GitHubData] Get all users error:",n),[]}}},l="openworld_user";class P{constructor(){this.user=this.loadUser(),this.listeners=[]}loadUser(){try{const e=localStorage.getItem(l),t=e?JSON.parse(e):null;if(t){if(!t.accessToken)return console.warn("[Auth] User data missing valid access token. Clearing session."),localStorage.removeItem(l),null;console.log("[Auth] User loaded:",t.username)}return t}catch(e){return console.error("[Auth] Error loading user:",e),localStorage.removeItem(l),null}}getUser(){return this.user}getAccessToken(){var e;return((e=this.user)==null?void 0:e.accessToken)||null}isLoggedIn(){return!!this.user}login(){window.location.href="/.netlify/functions/auth-login"}logout(){this.user=null,localStorage.removeItem(l),this.notify()}updateProfile(e){if(!this.user)return;this.user={...this.user,...e},localStorage.setItem(l,JSON.stringify(this.user));const t=this.getAccessToken();t&&A.save(this.user,t).catch(console.error),this.notify()}async followUser(e,t="follow"){const o=this.getAccessToken();if(!o)throw new Error("Not logged in");if(this.user){let r=this.user.followingList||[];t==="follow"&&!r.includes(e)?(r.push(e),this.user.following=(this.user.following||0)+1):t==="unfollow"&&r.includes(e)&&(r=r.filter(s=>s!==e),this.user.following=Math.max(0,(this.user.following||0)-1)),this.user.followingList=r,localStorage.setItem(l,JSON.stringify(this.user)),this.notify()}try{const r=await fetch("/.netlify/functions/follow-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({targetUsername:e,action:t})});if(!r.ok)throw new Error("Follow action failed");return await r.json()}catch(r){throw console.error("Follow error:",r),r}}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notify(){this.listeners.forEach(e=>e(this.user))}}const c=new P;class S{constructor(){this.posts=[],this.loaded=!1}async loadPosts(){if(this.loaded)return this.posts;try{console.log("[Posts] Loading from GitHub...");const e=c.getAccessToken();this.posts=await h.getAll(e),this.loaded=!0,console.log("[Posts] Loaded",this.posts.length,"posts")}catch(e){console.error("[Posts] Load error:",e),this.posts=[]}return this.posts}getPosts(){return this.posts.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt))}getPostsByUser(e){const t=String(e).toLowerCase();return this.posts.filter(o=>String(o.userId)===String(e)||o.username&&o.username.toLowerCase()===t)}async createPost({content:e,type:t="thought",repo:o=null,code:r=null}){const s=c.getUser();if(!s)throw new Error("Not logged in");const a=c.getAccessToken();if(!a)throw new Error("No access token");const i={id:"post_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),userId:s.id,username:s.username,userAvatar:s.avatar,userName:s.name,content:e,type:t,repo:o,code:r,reactions:{fire:0,heart:0,rocket:0},comments:0,createdAt:new Date().toISOString()};try{await h.create(i,a),this.posts.unshift(i),console.log("[Posts] Created post:",i.id)}catch(u){throw console.error("[Posts] Create error:",u),new Error("Failed to save post: "+u.message)}return i}async reactToPost(e,t){const o=c.getAccessToken();if(!o)return null;try{const r=await h.react(e,t,o);if(r&&r.post){const s=this.posts.find(a=>a.id===e);return s&&(s.reactions=r.post.reactions),{id:e,reactions:r.post.reactions,hasReacted:r.hasReacted}}return null}catch(r){return console.error("[Posts] React error:",r),null}}async deletePost(e){const t=c.getUser(),o=c.getAccessToken();if(!t||!o)return!1;const r=this.posts.findIndex(s=>s.id===e&&s.userId===t.id);if(r>-1)try{return await h.delete(e,t.username,o),this.posts.splice(r,1),!0}catch(s){console.error("[Posts] Delete error:",s)}return!1}startPolling(e=4e3){this.pollInterval||(this.pollInterval=setInterval(async()=>{try{const t=c.getAccessToken(),o=await h.getAll(t);this.reconcilePosts(o)}catch(t){console.error("[Posts] Polling error (silent):",t)}},e))}stopPolling(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)}reconcilePosts(e){!e||!Array.isArray(e)||e.forEach(t=>{const o=this.posts.find(r=>r.id===t.id);if(o){const r=o.reactions||{fire:0,heart:0,rocket:0},s=t.reactions||{fire:0,heart:0,rocket:0};JSON.stringify(r)!==JSON.stringify(s)&&(o.reactions=s,this.updateReactionUI(t.id,s));const a=Array.isArray(o.comments)?o.comments.length:o.comments||0,i=Array.isArray(t.comments)?t.comments.length:t.comments||0;a!==i&&(o.comments=t.comments,this.updateCommentCountUI(t.id,i))}else this.posts.some(r=>r.id===t.id)||this.posts.unshift(t)})}updateReactionUI(e,t){const o=document.querySelector(`.post-card[data-post-id="${e}"]`);if(!o)return;((s,a)=>{const i=o.querySelector('.post-card__action[data-action="react"]');if(i){const u=i.querySelector("span"),w=Object.values(t).reduce((g,m)=>g+m,0);u&&(u.textContent=w)}})("fire",t.fire||0)}updateCommentCountUI(e,t){const o=document.querySelector(`.post-card[data-post-id="${e}"]`);if(!o)return;const r=o.querySelector('.post-card__action[data-action="comment"] span');r&&(r.textContent=t)}}const v=new S;async function j(){const n=c.getAccessToken();if(!n)return[];try{const e=await fetch("/.netlify/functions/get-repos",{headers:{Authorization:`Bearer ${n}`}});if(!e.ok)throw new Error("Failed to fetch repos");return await e.json()}catch(e){return console.error("Error fetching repos:",e),[]}}function b(n){const e=new Date(n),o=new Date-e,r=Math.floor(o/6e4),s=Math.floor(o/36e5),a=Math.floor(o/864e5);return r<1?"just now":r<60?`${r}m`:s<24?`${s}h`:a<7?`${a}d`:e.toLocaleDateString("en-US",{month:"short",day:"numeric"})}export{c as a,j as b,$ as c,b as f,v as p,I as r,A as u};

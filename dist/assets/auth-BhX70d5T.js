(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();const f="anticontainmentsystem",d="openworld-data",p="https://api.github.com";async function w(n,e=null){try{const t={Accept:"application/vnd.github.v3+json"};e&&(t.Authorization=`Bearer ${e}`);const o=await fetch(`${p}/repos/${f}/${d}/contents/${n}`,{headers:t});if(!o.ok){if(o.status===404)return null;throw new Error(`GitHub API error: ${o.status}`)}const r=await o.json();if(!r.content)return console.warn("[GitHubData] File has no content:",n),{data:[],sha:r.sha};let s=decodeURIComponent(escape(window.atob(r.content)));s.charCodeAt(0)===65279&&(s=s.slice(1));try{return{data:JSON.parse(s),sha:r.sha}}catch(a){return console.error("[GitHubData] React content parse error:",a),{data:[],sha:r.sha}}}catch(t){if(console.error("[GitHubData] Read error:",t),t.message.includes("404"))return null;throw t}}const u={async getAll(n=null){try{const e=await w("posts.json",n);return(e==null?void 0:e.data)||[]}catch(e){return console.error("Failed to load posts:",e),[]}},async get(n,e){try{const t=await fetch(`/.netlify/functions/get-post?id=${n}`,{headers:{Authorization:`Bearer ${e}`}});return t.ok?await t.json():null}catch(t){return console.error("[PostsAPI] Get error:",t),null}},async create(n,e){try{const t=await fetch("/.netlify/functions/create-post",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!t.ok){const o=await t.json();throw new Error(o.error||"Failed to create post")}return await t.json()}catch(t){throw console.error("[PostsAPI] Create error:",t),t}},async delete(n,e,t){try{return!!(await(await fetch("/.netlify/functions/manage-post",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({action:"delete",postId:n})})).json()).success}catch(o){return console.error("[PostsAPI] Delete error:",o),!1}},async react(n,e,t){try{return(await(await fetch("/.netlify/functions/manage-post",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({action:"react",postId:n,reactionType:e})})).json()).success?{id:n,reactions:{[e]:1}}:null}catch(o){return console.error("[PostsAPI] React error:",o),null}}},A={async add(n,e,t,o){try{const r=await fetch("/.netlify/functions/add-comment",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({postId:n,content:e,attachments:t})}),s=await r.json();if(!r.ok)throw new Error(s.error||"Failed to add comment");return s.comment}catch(r){throw console.error("[CommentsAPI] Add error:",r),r}}},P={async getContents(n,e,t="",o){try{const r=t?`&path=${encodeURIComponent(t)}`:"",s=`/.netlify/functions/get-repo-contents?owner=${n}&repo=${e}${r}`,a=await fetch(s,{headers:{Authorization:`Bearer ${o}`}});return a.ok?await a.json():[]}catch(r){return console.error("[ReposAPI] Contents error:",r),[]}},async getForks(n,e,t){try{const o=await fetch(`/.netlify/functions/get-forks?owner=${n}&repo=${e}`,{headers:{Authorization:`Bearer ${t}`}});return o.ok?await o.json():[]}catch(o){return console.error("[ReposAPI] Forks error:",o),[]}},async search(n,e){try{const o=await(await fetch(`/.netlify/functions/search-repos?q=${encodeURIComponent(n)}`,{headers:{Authorization:`Bearer ${e}`}})).json();return o.error||!Array.isArray(o)?[]:o}catch(t){return console.error("[ReposAPI] Search error:",t),[]}}},y={async get(n,e=null){try{const t=await w(`users/${n}.json`,e);return(t==null?void 0:t.data)||null}catch{return null}},async save(n,e){try{const t=await fetch("/.netlify/functions/update-profile",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!t.ok){const r=await t.json();throw new Error(r.error||"Failed to save profile")}return(await t.json()).profile}catch(t){throw console.error("Failed to save user:",t),t}},async getAll(){try{const n=await fetch(`${p}/repos/${f}/${d}/contents/users`,{headers:{Accept:"application/vnd.github.v3+json"}});if(!n.ok)return[];const e=await n.json(),t=[];for(const o of e)if(o.name.endsWith(".json")){const r=await this.get(o.name.replace(".json",""));r&&t.push(r)}return t}catch(n){return console.error("[GitHubData] Get all users error:",n),[]}}},c="openworld_user";class g{constructor(){this.user=this.loadUser(),this.listeners=[]}loadUser(){try{const e=localStorage.getItem(c),t=e?JSON.parse(e):null;if(t){if(!t.accessToken)return console.warn("[Auth] User data missing valid access token. Clearing session."),localStorage.removeItem(c),null;console.log("[Auth] User loaded:",t.username)}return t}catch(e){return console.error("[Auth] Error loading user:",e),localStorage.removeItem(c),null}}getUser(){return this.user}getAccessToken(){var e;return((e=this.user)==null?void 0:e.accessToken)||null}isLoggedIn(){return!!this.user}login(){window.location.href="/.netlify/functions/auth-login"}logout(){this.user=null,localStorage.removeItem(c),this.notify()}updateProfile(e){if(!this.user)return;this.user={...this.user,...e},localStorage.setItem(c,JSON.stringify(this.user));const t=this.getAccessToken();t&&y.save(this.user,t).catch(console.error),this.notify()}async followUser(e,t="follow"){const o=this.getAccessToken();if(!o)throw new Error("Not logged in");if(this.user){let r=this.user.followingList||[];t==="follow"&&!r.includes(e)?(r.push(e),this.user.following=(this.user.following||0)+1):t==="unfollow"&&r.includes(e)&&(r=r.filter(s=>s!==e),this.user.following=Math.max(0,(this.user.following||0)-1)),this.user.followingList=r,this.notify()}try{const r=await fetch("/.netlify/functions/follow-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({targetUsername:e,action:t})});if(!r.ok)throw new Error("Follow action failed");return await r.json()}catch(r){throw console.error("Follow error:",r),r}}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notify(){this.listeners.forEach(e=>e(this.user))}}const i=new g;class m{constructor(){this.posts=[],this.loaded=!1}async loadPosts(){if(this.loaded)return this.posts;try{console.log("[Posts] Loading from GitHub...");const e=i.getAccessToken();this.posts=await u.getAll(e),this.loaded=!0,console.log("[Posts] Loaded",this.posts.length,"posts")}catch(e){console.error("[Posts] Load error:",e),this.posts=[]}return this.posts}getPosts(){return this.posts.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt))}getPostsByUser(e){return this.posts.filter(t=>t.userId===e)}async createPost({content:e,type:t="thought",repo:o=null,code:r=null}){const s=i.getUser();if(!s)throw new Error("Not logged in");const a=i.getAccessToken();if(!a)throw new Error("No access token");const l={id:"post_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),userId:s.id,username:s.username,userAvatar:s.avatar,userName:s.name,content:e,type:t,repo:o,code:r,reactions:{fire:0,heart:0,rocket:0},comments:0,createdAt:new Date().toISOString()};try{await u.create(l,a),this.posts.unshift(l),console.log("[Posts] Created post:",l.id)}catch(h){throw console.error("[Posts] Create error:",h),new Error("Failed to save post: "+h.message)}return l}async reactToPost(e,t){const o=i.getAccessToken(),r=this.posts.find(s=>s.id===e);if(r&&r.reactions[t]!==void 0&&(r.reactions[t]++,o))try{await u.react(e,t,o)}catch(s){console.error("[Posts] React error:",s)}return r}async deletePost(e){const t=i.getUser(),o=i.getAccessToken();if(!t||!o)return!1;const r=this.posts.findIndex(s=>s.id===e&&s.userId===t.id);if(r>-1)try{return await u.delete(e,t.username,o),this.posts.splice(r,1),!0}catch(s){console.error("[Posts] Delete error:",s)}return!1}}const $=new m;async function S(){const n=i.getAccessToken();if(!n)return[];try{const e=await fetch("/.netlify/functions/get-repos",{headers:{Authorization:`Bearer ${n}`}});if(!e.ok)throw new Error("Failed to fetch repos");return await e.json()}catch(e){return console.error("Error fetching repos:",e),[]}}function j(n){const e=new Date(n),o=new Date-e,r=Math.floor(o/6e4),s=Math.floor(o/36e5),a=Math.floor(o/864e5);return r<1?"just now":r<60?`${r}m`:s<24?`${s}h`:a<7?`${a}d`:e.toLocaleDateString("en-US",{month:"short",day:"numeric"})}export{i as a,S as b,A as c,j as f,$ as p,P as r,y as u};
